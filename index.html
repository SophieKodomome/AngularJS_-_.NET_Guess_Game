<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Guess Number</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script>
      var app = angular.module("ng-guess", []);

      app.service("guessService", function () {
        this.randomResult = Math.floor(Math.random() * 101);
        this.randomArray = createRandomArray();
        this.operationString = "( ) * + - /".split(" ");

        this.getRandomResult = function () {
          return this.randomResult;
        };

        this.getRandomArray = function () {
          return this.randomArray;
        };

        this.getOperationString = function () {
          return this.operationString;
        };

        function createRandomArray() {
          var randomArray = [];
          var randomNumber = null;
        }
          function createRandomArray() {
          var randomArray = [];
          var randomNumber = null;
          for (let index = 0; index < 5; index++) {
            randomNumber = Math.floor(Math.random() * 101);
            do {
              randomNumber = Math.floor(Math.random() * 101);
            } while (randomNumber == this.randomResult);
            randomArray.push(randomNumber);
          }
          return randomArray;
        }
      });

      app.controller("board", function ($scope, guessService) {
        $scope.randomResult = guessService.getRandomResult();
        $scope.randomArray = guessService.getRandomArray();
      });

      app.controller(
        "player_1",
        function ($scope, $interval, guessService, $rootScope) {
          $scope.randomArray = guessService.getRandomArray();
          $scope.randomResult = guessService.getRandomResult();
          $scope.operationString = guessService.getOperationString();
          $scope.playerResult = "";
          $scope.playerDifference = null;
          $scope.useState = true;
          $scope.seconds = 30;
          $scope.finished = false;

          $scope.append = function (value) {
            $scope.playerResult += value;
          };

          $scope.clear = function () {
            $scope.playerResult = "";
          };

          $scope.toggleState = function () {
            $scope.useState = !$scope.useState;
          };

          $scope.execute = function () {
            if (!$scope.finished) {
              $scope.toggleState();
              $scope.calculate();
              $scope.showDifference();
              $interval.cancel(timer);
              $scope.finished = true;
              $rootScope.player1Time = 30 - $scope.seconds;
              $rootScope.player1Result = $scope.playerResult;
              $rootScope.player1Difference = $scope.playerDifference;
              $rootScope.player1Finished = true;
              $scope.checkWinner();
            }
          };

          $scope.calculate = function () {
            try {
              $scope.playerResult = eval($scope.playerResult);
            } catch (e) {
              $scope.playerResult = "Error";
            }
          };

          $scope.showDifference = function () {
            if ($scope.playerResult !== "Error") {
              $scope.playerDifference = Math.abs(
                $scope.playerResult - $scope.randomResult
              );
            }
          };

          var timer = $interval(function () {
            if ($scope.seconds > 0) {
              $scope.seconds--;
            } else {
              $scope.execute();
            }
          }, 1000);

          $scope.$on("$destroy", function () {
            $interval.cancel(timer);
          });

          $scope.checkWinner = function () {
            if ($rootScope.player1Finished && $rootScope.player2Finished) {
              if ($scope.playerResult == $scope.randomResult) {
                alert("Player 1 wins with the exact result!");
              } else if ($rootScope.player2Result == $scope.randomResult) {
                alert("Player 2 wins with the exact result!");
              } else if (
                $scope.playerDifference < $rootScope.player2Difference
              ) {
                alert("Player 1 wins by being closer!");
              } else if (
                $scope.playerDifference > $rootScope.player2Difference
              ) {
                alert("Player 2 wins by being closer!");
              } else {
                if ($rootScope.player1Time < $rootScope.player2Time) {
                  alert("Player 1 wins by being faster!");
                } else {
                  alert("Player 2 wins by being faster!");
                }
              }
            }
          };

          $rootScope.player1Finished = false;
        }
      );

      app.controller(
        "player_2",
        function ($scope, $interval, guessService, $rootScope) {
          $scope.randomArray = guessService.getRandomArray();
          $scope.randomResult = guessService.getRandomResult();
          $scope.operationString = guessService.getOperationString();
          $scope.playerResult = "";
          $scope.playerDifference = null;
          $scope.useState = true;
          $scope.seconds = 30;
          $scope.finished = false;

          $scope.append = function (value) {
            $scope.playerResult += value;
          };

          $scope.clear = function () {
            $scope.playerResult = "";
          };

          $scope.toggleState = function () {
            $scope.useState = !$scope.useState;
          };

          $scope.execute = function () {
            if (!$scope.finished) {
              $scope.toggleState();
              $scope.calculate();
              $scope.showDifference();
              $interval.cancel(timer);
              $scope.finished = true;
              $rootScope.player2Time = 30 - $scope.seconds;
              $rootScope.player2Result = $scope.playerResult;
              $rootScope.player2Difference = $scope.playerDifference;
              $rootScope.player2Finished = true;
              $scope.checkWinner();
            }
          };

          $scope.calculate = function () {
            try {
              $scope.playerResult = eval($scope.playerResult);
            } catch (e) {
              $scope.playerResult = "Error";
            }
          };

          $scope.showDifference = function () {
            if ($scope.playerResult !== "Error") {
              $scope.playerDifference = Math.abs(
                $scope.playerResult - $scope.randomResult
              );
            }
          };

          var timer = $interval(function () {
            if ($scope.seconds > 0) {
              $scope.seconds--;
            } else {
              $scope.execute();
            }
          }, 1000);

          $scope.$on("$destroy", function () {
            $interval.cancel(timer);
          });

          $scope.checkWinner = function () {
            if ($rootScope.player1Finished && $rootScope.player2Finished) {
              if ($scope.playerResult == $scope.randomResult) {
                alert("Player 2 wins with the exact result!");
              } else if ($rootScope.player1Result == $scope.randomResult) {
                alert("Player 1 wins with the exact result!");
              } else if (
                $scope.playerDifference < $rootScope.player1Difference
              ) {
                alert("Player 2 wins by being closer!");
              } else if (
                $scope.playerDifference > $rootScope.player1Difference
              ) {
                alert("Player 1 wins by being closer!");
              } else {
                if ($rootScope.player2Time < $rootScope.player1Time) {
                  alert("Player 2 wins by being faster!");
                } else {
                  alert("Player 1 wins by being faster!");
                }
              }
            }
          };

          $rootScope.player2Finished = false;
        }
      );
    </script>
  </head>
  <body ng-app="ng-guess">
    <header ng-controller="board">
      <h1>{{randomResult}}</h1>
      <section ng-repeat="randomNumber in randomArray">
        <span>{{randomNumber}}</span>
      </section>
    </header>
    <article>
      <section ng-controller="player_1">
        <header>
          <h1>Player 1</h1>
          <h2>{{seconds}} seconds left</h2>
        </header>
        <section>
          <section>
            <label ng-show="useState">Operation</label>
            <label ng-show="!useState">Result</label>
            <input type="text" ng-model="playerResult" readonly />
          </section>
          <section>
            <label>this close</label>
            <input type="text" ng-model="playerDifference" readonly />
          </section>
        </section>

        <section>
          <section ng-repeat="randomNumber in randomArray">
            <button ng-click="append(randomNumber)">{{randomNumber}}</button>
          </section>
          <section ng-repeat="operationChar in operationString">
            <button ng-click="append(operationChar)">{{operationChar}}</button>
          </section>
        </section>
        <section>
          <button ng-click="clear()">Clear</button>
          <button ng-show="useState" ng-click="execute()">Calculate</button>
        </section>
      </section>

      <section ng-controller="player_2">
        <header>
          <h1>Player 2</h1>
          <h2>{{seconds}} seconds left</h2>
        </header>
        <section>
          <section>
            <label ng-show="useState">Operation</label>
            <label ng-show="!useState">Result</label>
            <input type="text" ng-model="playerResult" readonly />
          </section>
          <section>
            <label>this close</label>
            <input type="text" ng-model="playerDifference" readonly />
          </section>
        </section>

        <section>
          <section ng-repeat="randomNumber in randomArray">
            <button ng-click="append(randomNumber)">{{randomNumber}}</button>
          </section>
          <section ng-repeat="operationChar in operationString">
            <button ng-click="append(operationChar)">{{operationChar}}</button>
          </section>
        </section>
        <section>
          <button ng-click="clear()">Clear</button>
          <button ng-show="useState" ng-click="execute()">Calculate</button>
        </section>
      </section>
    </article>
  </body>
</html>
